<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FlightSmart | Flight Planner</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.19.0/js/md5.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a1a; color: white; padding: 40px; }
        .container { max-width: 600px; margin: auto; background: #2a2a2a; padding: 30px; border-radius: 12px; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: none; border-radius: 5px; background: #333; color: white; box-sizing: border-box;}
        button { width: 100%; padding: 15px; background: #0070f3; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 10px;}
        button:hover { background: #0056b3; }
        #output { margin-top: 20px; display: none; border-top: 1px solid #444; padding-top: 20px; background: #222; border-radius: 8px; padding: 20px;}
        .loading { color: #f39c12; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>Flight Planner</h2>
    <form id="sbapiform">
        <label>SimBrief Username</label>
        <input type="text" id="sb-username" placeholder="e.g. your_simbrief_name" required>

        <label>Departure ICAO</label>
        <input type="text" id="orig" placeholder="e.g. KJFK" required>
        
        <label>Arrival ICAO</label>
        <input type="text" id="dest" placeholder="e.g. EGLL" required>
        
        <label>Aircraft Type</label>
        <input type="text" id="type" placeholder="e.g. A320" required>

        <button type="button" onclick="generateFlightPlan()">Generate Plan</button>
    </form>

    <div id="output">
        <p id="status-text">Generating...</p>
        <a id="pdf-link" target="_blank" style="color: #0070f3; text-decoration: none; display: none;">View Briefing Document (PDF)</a>
    </div>
</div>

<script>
    function generateFlightPlan() {
        const orig = document.getElementById('orig').value.toUpperCase();
        const dest = document.getElementById('dest').value.toUpperCase();
        const type = document.getElementById('type').value.toUpperCase();
        const username = document.getElementById('sb-username').value;

        if (!username || !orig || !dest || !type) {
            alert("Please fill in all fields!");
            return;
        }

        const apiKey = "8a1ASgWFRkAtaVAaRJtENheTFJq7oCqa";
        const timestamp = Math.floor(Date.now() / 1000);
        const callbackUrl = "https://flightsmart-github-io.vercel.app/callback.html";

        const hash = md5(apiKey + orig + dest + type + timestamp + callbackUrl);
        const simbriefURL = `https://www.simbrief.com/ofp/ofp.loader.api.php?orig=${orig}&dest=${dest}&type=${type}&timestamp=${timestamp}&outputpage=${encodeURIComponent(callbackUrl)}&apicode=${hash}`;

        // 1. Open the popup to generate the plan
        const popup = window.open(simbriefURL, "simbrief_popup", "width=500,height=700");

        // 2. Update UI to show loading state
        const outputDiv = document.getElementById('output');
        const statusText = document.getElementById('status-text');
        const pdfLink = document.getElementById('pdf-link');
        
        outputDiv.style.display = 'block';
        pdfLink.style.display = 'none';
        statusText.className = "loading";
        statusText.innerText = "Generating plan in popup... Please wait.";

        // 3. Keep checking every second to see if the popup closed
        const checkPopup = setInterval(() => {
            if (popup.closed) {
                clearInterval(checkPopup);
                statusText.innerText = "Plan generated! Fetching data...";
                fetchResults(username); // Trigger the data fetch
            }
        }, 1000);
    }

    async function fetchResults(username) {
        try {
            // Fetch the completed plan directly from SimBrief
            const response = await fetch(`https://www.simbrief.com/api/xml.fetcher.php?username=${username}&json=1`);
            const data = await response.json();

            const statusText = document.getElementById('status-text');
            const pdfLink = document.getElementById('pdf-link');

            // Display the data right on the same page
            if (data && data.general) {
                statusText.className = "";
                statusText.innerHTML = `<strong>Status:</strong> Success<br>
                                        <strong>Route:</strong> ${data.general.route}<br>
                                        <strong>Cruise Alt:</strong> ${data.general.initial_alt}<br>
                                        <strong>Block Fuel:</strong> ${data.fuel.plan_ramp} lbs`;
                
                pdfLink.href = data.files.pdf.link;
                pdfLink.style.display = 'inline-block';
                pdfLink.style.marginTop = '15px';
            } else {
                statusText.innerText = "Error: Could not retrieve plan. Make sure the popup finished successfully.";
            }
        } catch (error) {
            console.error("Fetch error:", error);
            document.getElementById('status-text').innerText = "Failed to load data. Please try again.";
        }
    }
</script>

</body>
</html>